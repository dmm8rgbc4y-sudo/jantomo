{% extends 'base.html' %}
{% block title %}å‹é”ä¸€è¦§ - ã˜ã‚ƒã‚“ã¨ã‚‚{% endblock %}

{% block content %}
<header class="page-header">
  <h2>å‹é”ä¸€è¦§</h2>
  <div class="friend-header-buttons">
    <a href="{{ url_for('friend.friend_request') }}" class="add-friend-btn">ï¼‹ å‹é”ã‚’è¿½åŠ </a>
    <a href="{{ url_for('friend.friend_inbox') }}" class="inbox-btn" id="inbox-btn">
      ç”³è«‹å—é ˜
      <span id="inbox-badge" class="badge"></span>
    </a>
  </div>
</header>

<div class="friends-list">
  {% if friends %}
    {% for f in friends %}
      <div class="friend-item">
        <div class="friend-icon">{{ f.username[0] }}</div>
        <div class="friend-name">{{ f.username }}</div>

        <form method="POST" action="{{ url_for('friend.friend_delete') }}">

          <!-- ğŸ” Flask-WTF æ­£å¼ã® CSRF hidden field -->
          {{ csrf_field() }}

          <input type="hidden" name="friend_id" value="{{ f.id }}">
          <button type="submit" class="delete-btn">å‰Šé™¤</button>
        </form>

      </div>
    {% endfor %}
  {% else %}
    <p class="no-friends">å‹é”ãŒã¾ã ã„ã¾ã›ã‚“ã€‚</p>
  {% endif %}
</div>

<!-- ğŸ”” ãƒãƒƒã‚¸æ›´æ–°ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
async function updateInboxBadge() {
  try {
    const res = await fetch("/friend/pending-count");
    if (!res.ok) return;
    const data = await res.json();
    const badge = document.getElementById("inbox-badge");
    if (data.count > 0) {
      badge.textContent = data.count;
      badge.style.display = "inline";
    } else {
      badge.style.display = "none";
    }
  } catch (err) {
    console.error("ãƒãƒƒã‚¸æ›´æ–°å¤±æ•—:", err);
  }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
document.addEventListener("DOMContentLoaded", updateInboxBadge);

// 30ç§’ã”ã¨ã«æ›´æ–°
setInterval(updateInboxBadge, 30000);
</script>
{% endblock %}
